<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="tag-item.html">

<dom-module id="tags-list">
    <template>
        <style is="custom-style" include="dialogs"></style>
        <style include="shared-styles">
            :host {
                display: block;
                width: 100%;
            }
        </style>

        <paper-dialog id="tagsModal" entry-animation="scale-up-animation" exit-animation="fade-out-animation" with-backdrop>
            <h2>Tags</h2>
            <paper-icon-button icon="clear" class="close" dialog-dismiss></paper-icon-button>
            <paper-dialog-scrollable>
                <table class="info-table">
                    <template is="dom-repeat" items="[[tags]]" as="tag">
                        <tag-item tag="[[tag]]"></tag-item>
                    </template>
                </table>

                <div class="clearfix bottom-actions xs12">
                    <paper-button class="submit-btn pull-left" raised on-tap="_saveTags">Save Tags</paper-button>
                    <paper-button class="submit-btn pull-right" raised on-tap="_addTag">Add Tag</paper-button>
                </div>
            </paper-dialog-scrollable>
        </paper-dialog>

        <iron-ajax id="tagsAjaxRequest" method="POST" on-response="_handleTagsAjaxResponse" on-error="_handleTagsAjaxError"></iron-ajax>
    </template>

    <script>
        (function() {
            'use strict';

            Polymer({
                is: 'tags-list',

                properties: {
                    type: String,
                    resource: Object,
                    tags: {
                        type: Array,
                        computed: '_computeTags(resource.tags.*)'
                    },
                    url: {
                        type: String,
                        computed: '_computeUrl(type, resource)'
                    }
                },
                listeners: {
                    'iron-overlay-closed': '_modalClosed',
                    'tag-delete': '_tagDeleteHandler'
                },
                _computeUrl: function(type, resource) {
                    switch (type) {
                        case 'cloud':
                            return '/api/v1/clouds/' + resource.cloud.id + '/machines/' + resource.id + '/tags';
                            break;
                        case 'machine':
                            return '/api/v1/clouds/' + resource.cloud.id + '/machines/' + resource.id + '/tags';
                            break;
                        case 'network':
                            return '/api/v1/clouds/' + resource.cloud.id + '/machines/' + resource.id + '/tags';
                            break;
                        case 'key':
                            return '/api/v1/clouds/' + resource.cloud.id + '/machines/' + resource.id + '/tags';
                            break;
                        case 'script':
                            return '/api/v1/clouds/' + resource.cloud.id + '/machines/' + resource.id + '/tags';
                            break;
                        default:
                            return '/api/v1/clouds/' + machine.cloud.id + '/machines/' + machine.id + '/tags';
                    }
                },
                _openDialog: function(e) {
                    this.querySelector('paper-dialog').open();
                },
                _closeDialog: function(e) {
                    this.querySelector('paper-dialog').close();
                },
                _modalClosed: function(e) {

                },
                _computeTags: function(tags) {
                    if (!tags.base.length) {
                        return [{
                            key: '',
                            value: ''
                        }];
                    }
                    return tags.base.slice();
                },
                _addTag: function() {
                    var newTag = {
                        key: '',
                        value: ''
                    };
                    this.push('tags', newTag);
                },
                _tagDeleteHandler: function(e) {
                    var tag = e.detail.tag,
                    index = this.tags.indexOf(tag);
                    this.splice('tags', index, 1);
                },
                _saveTags: function() {
                    var tags = this.tags.filter(function(tag) {
                        return tag.key && tag.value;
                    }), payloadTags = {};

                    if (tags.length) {
                        tags.forEach(function(tag) {
                            payloadTags[tag.key] = tag.value;
                        });

                        this.$.tagsAjaxRequest.body = {
                            tags: payloadTags
                        };
                        this.$.tagsAjaxRequest.url = this.get('url');
                        this.$.tagsAjaxRequest.headers["Content-Type"] = 'application/json';
                        this.$.tagsAjaxRequest.headers["Csrf-Token"] = CSRF_TOKEN;
                        this.$.tagsAjaxRequest.generateRequest();
                    }
                },
                _handleTagsAjaxResponse: function(e) {
                    console.log(e);
                }
            });
        })();
    </script>
</dom-module>
